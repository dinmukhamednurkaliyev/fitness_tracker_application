name: "PR: Auto-fill Commits"

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Update PR Description
        uses: actions/github-script@v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;

            const commits = await github.paginate(github.rest.pulls.listCommits, {
              owner, repo, pull_number: pr.number
            });

            const rows = commits.map(c => {
              const shortSha = c.sha.substring(0, 7);
              const message = c.commit.message.split('\n')[0];
              const url = c.html_url;

              return `<li><a href="${url}"><code>${shortSha}</code></a> ${message}</li>`;
            }).join('\n');

            const compareUrl = `${pr.html_url}/files`;

            const dependabotStyleBlock = `
            <!-- START_AUTO_SECTION -->

            <details>
              <summary><strong>Commits</strong></summary>
              <br />
              <ul>
            ${rows}
              </ul>
              <p><a href="${compareUrl}">Additional commits viewable in compare view</a></p>
            </details>

            <!-- END_AUTO_SECTION -->
            `;

            let body = pr.body || "";

            const regex = /<!-- START_AUTO_SECTION -->[\s\S]*<!-- END_AUTO_SECTION -->/;

            if (body.match(regex)) {
              body = body.replace(regex, dependabotStyleBlock);
            } else {
              body = body + "\n\n" + dependabotStyleBlock;
            }

            await github.rest.pulls.update({
              owner,
              repo,
              pull_number: pr.number,
              body: body
            });
